<html>
    <head>
        <link rel="stylesheet" href="../css/global.css">
        <link rel="stylesheet" href="../css/page.css">
        <link rel="preconnect" href="https://rsms.me/">
        <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
        <meta name = "viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="bar">
            <a class="circle" href="index.html"><img style="margin-left:-3px; -webkit-tap-highlight-color: transparent;" src="../library/icon-left-chevron.svg"></a>
            <img class="cecyte" src="../library/cecyte.png">
            <div class="circle" style="background: transparent; backdrop-filter: none;"></div>
        </div>
        <div class="centrador"><img class="big-symbol" src="../library/icon-lock.svg"></div>
        
        <div class="heading">Código de acceso</div>
        <div class="centrador"><div class="descripcion">Introduce el código de acceso para completar la operación</div></div>
        <div class="centrador"><input type="password" class="contraseña" id="password" maxlength="10" autofocus></div>
        <div class="help">¿No sabes el código? Si deseas compartir algo, solicítalo con tu administrador.</div>
        <button class="button" id="send">Publicar</button>
        
      <script>
  document.getElementById('send').addEventListener('click', async () => {
    const password = document.getElementById('password').value;
    const anuncio = JSON.parse(sessionStorage.getItem('nuevoAnuncio'));

    if (!anuncio) {
      alert('No hay anuncio para guardar.');
      return;
    }

    try {
      const verificacion = await fetch('/verificar-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ password })
      });

      if (!verificacion.ok) {
        alert('Contraseña incorrecta');
        return;
      }

      const respuesta = await fetch('/guardar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ anuncio, password })
      });

      const data = await respuesta.json();
      if (data.success) {
        alert('Anuncio guardado correctamente');
        sessionStorage.removeItem('nuevoAnuncio');
        window.location.href = './index.html';
      } else {
        alert('Error: ' + data.error);
      }

    } catch (err) {
      console.error(err);
      alert('Error de conexión');
    }
  });
</script>

    </body>
</html>